# README for running a netperf server

It's easy to run a netperf server.
Just stand up a VPS,
[download the netperf zip from https://github.com/HewlettPackard/netperf](https://github.com/HewlettPackard/netperf),
`make; make install; netserver &`,
open port 12865 on the firewall,
and you're on the air.

BUT...
A netperf server (for example, at [netperf.bufferbloat.net](http://netperf.bufferbloat.net)) is an attractive nuisance.
A garden-variety VPS can easily handle the load generated by a handful of network researchers.
But it has grown popular with people who want to test their network connection every five minutes, 24x7.
This rapidly exhausts the bandwidth caps of (low-cost) hosting plans, leading to increased expense or suspension of the server.

This repository contains a number of tools for identifying and shutting down "abusers" who run bandwidth tests continually.
It does this by using `iptables` rules to identify traffic to port 12865 (the default netperf port), counting the connections, and blocking addresses that cross a threshold.

*Current Settings:* The threshold is set at 200 connections per "day"
(the 24-48 hour time interval since midnight the previous day).
In addition, a Python script (`lookforconstantusers.py`) checks
for time stretches of connections without any breaks - 
indicating a potential bot.

This ballpark number was computed using the following factors: a normal "speed test" typically uses five simultaneous connections to "fill the pipe": first in the download phase then the upload phase.
Thus, a single speed test session creates 10 connections.
If the count exceeds the threshold (500),
it means that address has initiated about 50 speed tests over a 
day or two, so we stop accepting connections for that address.
The script currently runs every 30 minutes via a `cron` job.

The `findunfilteredips.sh` script also runs a program to examine
the time intervals and total duration of each IP's test requests.
If an address makes more than 20 tests
over a significant amount of time (>= 21 hours)
without a significant break (at least one 7 hour gap between tests),
then it gets flagged to be blacklisted.

**TL;DR** These settings seem to limit the total traffic to less than 4 TB/month (the limit on my cheap VPS server)
while not inconveniencing legitimate researchers or people tuning their home networks.

## The Details

The Ansible playbook `setup_iptables.yaml` configures the
full set of chains for the netperf server.
It performs these actions:

* Flushes INPUT, OUTPUT, and FORWARD chains
* Delete the NETPERF chain if it exists
* Delete the LIMITEDNETPERF chain if it exists
* Allow all traffic on the `lo` interface [1]
* Allow traffic from port 22 on any interface [1]
* Add a rule to INPUT to send every TCP packet with
dest_port 12865 to the NETPERF chain
* Create a NETPERF chain
* Add a rule to NETPERF to log "Incoming netperf " when one arrives,
then accept it
* Create a LIMITEDNETPERF chain
* Add a rule to LIMITEDNETPERF to reject any packet

[1] This rule isn't strictly necessary because the firewall doesn't
block traffic (except netperf abusers)

---
_The remainder of this section describes how all this works.
The Ansible playbook simply sets up the iptables machinery._

`iptables` is configured to log a message with a prefix of "Incoming netperf " each time a connection to port 12865 arrives.
Log entries (written to `/var/log/kern.log`) have the form:

```
Feb 11 03:11:45 atl kernel: [9353834.165208] Incoming netperf IN=lo OUT= MAC=00:00:00:00:00:00:00:00:00:00:00:00:08:00 
SRC=23.x.x.x DST=23.x.x.x LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38423 DF PROTO=TCP SPT=56374 DPT=12865 WINDOW=65535 RES=0x00 SYN 
URGP=0
```

The important scripts in this repo are:

* **listandblacklist.sh** runs via cron on a regular basis and emails its output for review.
This script calls each of the following scripts in sequence:

* **findunfiltered.sh ###** scans the `/var/log/kern.log*` files for those "Incoming 
netperf" lines,
isolates the SRC=... addresses, and creates a frequency count of those addresses. It writes a list of IP addresses
that occur more than the threshold to the `heavyusers.txt` file.

   The script then compares those new addresses (in `heavyusers.txt`) to the list of IP addresses that are already present in iptables with a LIMITEDNETPERF target
and writes new addresses to `filteredheavyusers.txt`

* **lookforconstantusers.py** Python program to compare time interval between tests
and overall duration to find blacklist addresses.

* **addtoblacklist.sh** reads `filteredheavyusers.txt` to update the `iptables` rules by adding each address to the INPUT chain with a -j LIMITEDNETPERF target.
The LIMITEDNETPERF chain drops the packet (and thus the connection.) 

## iptables setup   

First, (one time) create a NETPERF chain to handle those incoming netperf connections.
This will will log newly-arrived connections.
It also receives the rules (inserted at position 1)
for blacklisted addresses that jump to LIMITEDNETPERF

```
sudo iptables -N NETPERF
sudo iptables -A NETPERF -j LOG --log-prefix "Incoming netperf "
```

add a rule to the INPUT chain to detect each arriving netperf connection.
The command below appends (-A) to the INPUT chain a rule so that a TCP packet on port 12865 jumps to the NETPERF chain.

```
sudo iptables -A INPUT -p tcp --dport 12865 -j NETPERF
# (old) sudo iptables -A INPUT -p tcp --dport 12865 -j LOG --log-prefix "Incoming netperf "
```

Next, (one time) create a LIMITEDNETPERF chain to process packets that exceed the threshold.

```
sudo iptables -N LIMITEDNETPERF
# sudo iptables -A LIMITEDNETPERF -j LOG --log-prefix "Dropped netperf "
sudo iptables -A LIMITEDNETPERF -j REJECT
```

*Note:* This now (Mar2021) REJECT's the packet, instead of DROP'ing it,
so that the requestor knows that we are ignoring them.

*Note:* Originally, this chain logged a "Dropped netperf" message
(the second rule above), but it no longer does this.
That's because, under load, the logging messages for the high volume of dropped packets placed too much load on the server.

Finally, the `addtoblacklist.sh` script adds an `iptables` rule to the NETPERF chain that drops connections for the specified address:
insert (-I) a rule in the NETPERF chain at position 1, with criteria for the specified source address.
A matching packet "jumps to" the LIMITEDNETPERF chain that subsequently drops/rejects the packet.
This prevents the connection from becoming established.

```
sudo iptables -I NETPERF 1 --src <ip-address> -j LIMITEDNETPERF
```

The command above takes effect immediately.
If you wish the command to persist across reboots, you must use `iptables-save`, like this.
These commands must be run as root.

```
# rules for iptables-persistent
sudo su -c 'iptables-save  > /etc/iptables/rules.v4' 
sudo su -c 'ip6tables-save > /etc/iptables/rules.v6'

# don't use these
# sudo su -c 'iptables-save  > /etc/iptables.up.rules'
# sudo su -c 'ip6tables-save  > /etc/ip6tables.up.rules'
```
 
`iptables -nvL` displays counts of the number of packets and bytes processed by each of the `iptables` rules.

## iptables maintenance

Sometimes an address gets blacklisted in error.
To take it out of the blacklist:

1. Add the affected address to the end of the `whitelist.txt` file.

2. Grep the iptables output for the specific address and find its line number.

   ```
sudo iptables -nL --line-numbers | grep W.X.Y.Z
``` 

3. Substitute the line number for the `"#"` in the command below.
This removes the rule from the NETPERF chain.

   ```
sudo iptables -D NETPERF #
# Then use the iptables-save commands above to make permanent
```

## cron setup

Using `sudo crontab -e` add these lines:

```
# Send the output of the script via email
MAILTO="account@example.com"

# Run the listandblacklist script every 15 minutes
0,15,30,45 * * * * /home/deploy/src/netperfclean/listandblacklist.sh

# Remove all netperf log files once per hour
45 * * * * rm /var/log/netserver.debug*
```

## rsyslog setup

iptables is always running.
And it sends all its LOG messages to `kern.*`
But rsyslog needs to be configured to receive imklog messages and send them to a specific file.
These two files must be configured:

**/etc/rsyslog.conf**

```
...
module(load="imklog")
...
$IncludeConfig /etc/rsyslog.d/*.conf
...
```

**/etc/rsyslog.d/50-default.conf**

```
...
kern.*				-/var/log/kern.log
...
```

Optionally, additional files can be configured in `/etc/rsyslog.d/`
that govern treatment for log messages.
These must be numerically *before* `50-default.conf` to take precedence.
For example, [this file](https://askubuntu.com/questions/348439/where-can-i-find-the-iptables-log-file-and-how-can-i-change-its-location/348448#348448) intercepts messages that contain "[netfilter] "
and redirects them to `/var/log/iptables.log`.
It also stops processing of the messge, so it won't appear in other logs.

**/etc/rsyslog.d/10-iptables.log**

*This is unsubstantiated, and isn't currently working 25Feb2021*

```
# This is unsubstantiated...
:msg,contains,"[netfilter] " -/var/log/iptables.log
& stop
```

rsyslog must be restarted to recognize changes to rsyslog configuration files. 

```
sudo service rsyslog restart
```

## Potential To-do's

The scripts currently work to my satisfaction, keeping total bandwidth per month to less than 4 TBytes.
I have had a few idle speculations for optimizations if needed:

1. I am told that `ipset` is a better way to match large numbers of IP addresses.
At the moment, my iptables list has about 800 addresses with no obvious effect on the server.
However, that list is growing by 10 devices per day (with an unknown upper bound),
so `ipset` may become necessary in the future.

2. There's another possibility for detecting abuse that I have not investigated.
To date, these scripts to not attempt to use any `iptables` rate limiting functions.
Normally, an address creeps up to the limit over time, then exceeds it and gets blacklisted.

   However, there have been occasions where the IP addresses have accumulated thousands (in one case, 14,000) of new connections between 30-minute runs of the cron job.
(This can be detected from the output of the `findunfilteredips.sh` script.
It displays two lists:
addresses that were just blocked because they exceeded the (500) connection threshold,
and a sorted list of 30 heavy addresses.)
Such a large jump is an obvious signal of abuse: it may be worth estimating the bandwidth consumed to see if it makes sense to find a way to use `iptables` connection rate limiting rules to detect and block the address earlier than the 30-minute test.

3. Current rules only block single IP addresses.
But a review of all addresses shows that there are obvious /24 or even /16 address ranges that maybe worth blocking.
(This suggests an organized attempt to run tests continually: when an address gets blocked, a different machine on the same subnet picks up heavy testing.)
Again, a review of the amount of the actual traffic involved could determine whether this effort was warranted.

4. There is no facility for automatically removing an address from the blacklist.
If someone writes to me and says their address seems to be blocked, I will simply remove their address from the rules.

5. *fail2ban* seems to have much in common with these scripts:
detecting some form of bad behavior and causing then not to connect. 

6. Abusing addresses don't get any feedback. 
Everything's working one moment, then stops, and never works again.
It might be better feedback to drop the permitted bandwidth to something low - say 2 kbps.
It would even be a diagnostic clue if someone mentioned,
"Hey, I was using netperf.bufferbloat.net and it was working fine.
But since yesterday, I only get 2kbps, and I know that's not right..." 

## Old info - not necessarily up-to-date

Description of other files:

   * `countsofip.txt` - file that shows IP address counts in the form: ### 192.168.1.1
   * `heavyusers.txt` - IPs of devices with > *threshold* connections from log files
   * `whitelist.txt` - a file of IP addresses never to blacklist
   * `filteredheavyusers.txt` - heavy users not present in iptables
   * `iptables-addresses.txt` - addresses with LIMITEDNETPERF as the target in iptables
   * `iptables.txt` - raw output of 'iptables -nL'
   * `kernlog.txt` - concatenated output of all log files
   * `sh checkdistrib.sh <ipaddress>` - a script to display the number of tests for each one-hour interval for a specified address.
This indicates whether the device was continually testing, or tested for a while, then stopped, then started again.
   * `logscan.sh` precursor to findunfilteredips.sh. It scans the kern.log* files, and
shows counts for "Incoming" and "Dropped" netperf connections.

